<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chicagoland Maternal Mental Health Providers (Proof of Concept)</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    /* ...all your styles as before... */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    #map { width: 100%; height: 100%; }
    .controls-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 14px 16px;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      font-size: 18px;
      max-width: 300px;
    }
    .controls-container h3 { margin: 0 0 8px 0; font-size: 20px; }
    .controls-container label {
      display: flex;
      align-items: center;
      margin: 4px 0;
      cursor: pointer;
      line-height: 1.4;
    }
    .controls-container input[type="checkbox"] {
      width: 20px; height: 20px; margin-right: 10px; transform: scale(1.3);
    }
    .controls-container small { font-size: 12px; }
    .controls-container .fuzzy-search-label { margin: 6px 0 12px 0; }
    .controls-container input[type="text"] {
      width: 100%; font-size: 16px; padding: 4px 6px; margin-top: 3px;
      box-sizing: border-box; border-radius: 2px; border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="controls-container" id="filters">
    <h3>Filter providers</h3>
    <label>
      <input type="checkbox" id="filterVirtual" />
      Offers virtual services
    </label>
    <label>
      <input type="checkbox" id="filterMedicaid" />
      Accepts Medicaid
    </label>
    <label>
      <input type="checkbox" id="filterPMHC" />
      Has PMH-C specialist
    </label>
    <div class="fuzzy-search-label">
      <label for="fuzzySearchInput">Provider name search</label>
      <input type="text" id="fuzzySearchInput" placeholder="Fuzzy search by NAME..." />
    </div>
    <hr />
    <small>
      This is a proof of concept map of maternal mental health providers in Chicagoland.
    </small>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Add Fuse.js -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <script>
    // --- CONFIG ---
    const csvFilePath = 'https://rcshepard.github.io/MMH/MMHdata.csv';
    const hiddenFields = ['LATITUDE', 'LONGITUDE'];
    const map = L.map('map').setView([41.88, -87.63], 12);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
}).addTo(map);
	
	fetch('https://rcshepard.github.io/MMH/nosuburbs.geojson')
  .then(response => response.json())
  .then(geojsonData => {
    L.geoJSON(geojsonData, {
      style: {
        color: '#444',             // medium gray border
        fillColor: '#666',         // medium gray fill
        fillOpacity: 0.7,          // semi-opaque
        weight: 1
      }
    }).addTo(map);
  });

    const markersLayerGroup = L.layerGroup().addTo(map);
    let allProviderData = [];
    let fuse = null;        // Fuse.js instance
    let lastFuzzy = '';     // Fuzzy search input value

    function buildPopupHtml(row) {
      const url = row.URL && row.URL.trim() ? row.URL.trim() : null;
      const name = row.NAME || 'Provider';
      let html = '<div class="provider-popup">';
      html += '<strong>' + name + '</strong>';
      if (url) {
        const safeUrl = url.startsWith('https') ? url : 'https://' + url;
        html += '<br/><a href="' + safeUrl + '" target="_blank" rel="noopener noreferrer">Website</a>';
      }
      html += '<br/><br/><table>';
      for (const key in row) {
        if (!row.hasOwnProperty(key) || hiddenFields.includes(key) || key.startsWith('Unnamed')) continue;
        let label = key.replace(/_/g, ' ');
        const value = row[key] == null ? '' : String(row[key]).trim();
        if (value === '') continue;
        html += '<tr><th>' + label + '</th><td>' + value + '</td></tr>';
      }
      html += '</table></div>';
      return html;
    }

    function createProviderMarker(row) {
      const lat = parseFloat(row.LATITUDE);
      const lng = parseFloat(row.LONGITUDE);
      if (isNaN(lat) || isNaN(lng)) return null;
      const numProviders = row.NUM_PROVIDERS ? parseInt(row.NUM_PROVIDERS, 10) : null;
      const type = (row.AGENCY_INDIVIDUAL || '').toString().trim().toUpperCase();
      const isAgency = type === 'AGENCY' || type === 'A' || type === 'AGENCIES';
      const iconClass = isAgency ? 'agency-icon' : 'individual-icon';
      const icon = L.divIcon({
        className: '',
        html: '<span class="' + iconClass + '"></span>',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
      const marker = L.marker([lat, lng], { icon });
      if (!isNaN(numProviders) && numProviders > 0) {
        const labelHtml = '<div class="provider-label">' + numProviders + '</div>';
        marker.bindTooltip(labelHtml, {
          permanent: true,
          direction: 'top',
          className: 'provider-count-label'
        });
      }
      marker.bindPopup(buildPopupHtml(row));
      return marker;
    }

    function passesFilters(row, filters) {
      if (filters.virtual && String(row.VIRTUAL).toUpperCase() !== 'Y') return false;
      if (filters.medicaid && String(row.MEDICAID).toUpperCase() !== 'Y') return false;
      if (filters.pmhc && String(row.PMH_C).toUpperCase() !== 'Y') return false;
      return true;
    }

    const clusterRadiusMeters = 100;
    function clusterMarkers(markers) {
      const clusters = [];
      markers.forEach(marker => {
        const latLng = marker.getLatLng();
        let foundCluster = null;
        for (let i = 0; i < clusters.length; i++) {
          const clusterCenter = clusters[i].latLng;
          const distance = map.distance(latLng, clusterCenter);
          if (distance <= clusterRadiusMeters) {
            foundCluster = clusters[i];
            break;
          }
        }
        if (foundCluster) {
          foundCluster.markers.push(marker);
          const len = foundCluster.markers.length;
          const avgLat =
            (foundCluster.latLng.lat * (len - 1) + latLng.lat) / len;
          const avgLng =
            (foundCluster.latLng.lng * (len - 1) + latLng.lng) / len;
          foundCluster.latLng = L.latLng(avgLat, avgLng);
        } else {
          clusters.push({
            latLng: latLng,
            markers: [marker]
          });
        }
      });
      return clusters;
    }

    function applyFiltersAndRender() {
      const filters = {
        virtual: document.getElementById('filterVirtual').checked,
        medicaid: document.getElementById('filterMedicaid').checked,
        pmhc: document.getElementById('filterPMHC').checked
      };
      lastFuzzy = document.getElementById('fuzzySearchInput').value.trim();
      markersLayerGroup.clearLayers();
      let rowsFiltered = allProviderData.filter(row => passesFilters(row, filters));

      if (lastFuzzy && fuse) {
        // only show fuzzy matches
        const fuseResults = fuse.search(lastFuzzy);
        const ids = new Set(fuseResults.map(res => res.item.ID)); // or use NAME as unique key
        rowsFiltered = rowsFiltered.filter(row => ids.has(row.ID));
      }
      const markers = [];
      rowsFiltered.forEach(row => {
        const marker = createProviderMarker(row);
        if (marker) {
          markers.push(marker);
        }
      });
      if (markers.length === 0) return;
      const clusters = clusterMarkers(markers);
      const scaleFactor = 4;
      const allClusterMarkers = [];
      clusters.forEach(cluster => {
        const count = cluster.markers.length;
        const radius = Math.max(8, Math.sqrt(count) * scaleFactor);
        const circle = L.circleMarker(cluster.latLng, {
          radius: radius,
          color: '#0056b3',
          weight: 2,
          fillColor: '#4da3ff',
          fillOpacity: 0.6
        }).addTo(markersLayerGroup);
        circle.bindTooltip(
          '<div class="provider-label">' + count + '</div>',
          {
            permanent: true,
            direction: 'center',
            className: 'provider-count-label'
          }
        );
        circle.on('click', () => {
          let html = '';
          cluster.markers.forEach(m => {
            const content = m.getPopup() ? m.getPopup().getContent() : '';
            if (content) {
              if (html !== '') { html += '<hr/>'; }
              html += content;
            }
          });
          circle.bindPopup(html).openPopup();
        });
        allClusterMarkers.push(circle);
      });
      const group = L.featureGroup(allClusterMarkers);
      map.fitBounds(group.getBounds().pad(0.2));
    }

    Papa.parse(csvFilePath, {
      header: true,
      download: true,
      dynamicTyping: false,
      complete: function(results) {
        const rows = results.data.filter(row => {
          const hasId = row.ID && String(row.ID).trim() !== '';
          const hasName = row.NAME && String(row.NAME).trim() !== '';
          return hasId || hasName;
        });
        allProviderData = rows;
        fuse = new Fuse(allProviderData, {
          keys: ['NAME'],
          threshold: 0.4,
          ignoreLocation: true
        });
        applyFiltersAndRender();
      },
      error: function(err) {
        console.error('Error loading CSV:', err);
        alert('Failed to load provider data CSV. Check console for details.');
      }
    });

    document.getElementById('filterVirtual').addEventListener('change', applyFiltersAndRender);
    document.getElementById('filterMedicaid').addEventListener('change', applyFiltersAndRender);
    document.getElementById('filterPMHC').addEventListener('change', applyFiltersAndRender);
    document.getElementById('fuzzySearchInput').addEventListener('input', applyFiltersAndRender);
  </script>
</body>
</html>