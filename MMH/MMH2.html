<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chicagoland Maternal Mental Health Providers (Proof of Concept)</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Leaflet MarkerCluster CSS (no longer used, but you can remove later if desired) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .controls-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 14px 16px;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      font-size: 18px; /* larger font */
      max-width: 300px;
    }
    .controls-container h3 {
      margin: 0 0 8px 0;
      font-size: 20px; /* larger heading */
    }
    .controls-container label {
      display: flex;
      align-items: center;
      margin: 4px 0;
      cursor: pointer;
      line-height: 1.4;
    }
    .controls-container input[type="checkbox"] {
      width: 20px;   /* larger checkbox */
      height: 20px;  /* larger checkbox */
      margin-right: 10px;
      transform: scale(1.3); /* double-ish visual size */
    }
    .controls-container small {
      font-size: 12px;
    }

    .provider-label {
      font-weight: 700;
      font-size: 11px;
      color: #2b2b2b;
      text-align: center;
    }
    .provider-popup {
      font-size: 13px;
      line-height: 1.3;
    }
    .provider-popup a {
      color: #0056b3;
      text-decoration: none;
    }
    .provider-popup a:hover {
      text-decoration: underline;
    }
    .provider-popup table {
      border-collapse: collapse;
      width: 100%;
    }
    .provider-popup th,
    .provider-popup td {
      text-align: left;
      padding: 2px 4px;
      vertical-align: top;
    }
    .provider-popup th {
      white-space: nowrap;
      font-weight: 600;
      padding-right: 6px;
    }

    /* Optional: style the tooltip that shows NUM_PROVIDERS */
    .leaflet-tooltip.provider-count-label {
      background: transparent;
      border: none;
      box-shadow: none;
    }

    /* Different icon colors for agencies vs individuals */
    .agency-icon {
      background-color: #e74c3c;
      border-radius: 50%;
      border: 2px solid #c0392b;
      width: 16px;
      height: 16px;
      box-shadow: 0 0 4px rgba(0,0,0,0.4);
    }
    .individual-icon {
      background-color: #2ecc71;
      border-radius: 50%;
      border: 2px solid #27ae60;
      width: 16px;
      height: 16px;
      box-shadow: 0 0 4px rgba(0,0,0,0.4);
    }
    .agency-icon,
    .individual-icon {
      display: block;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Filters UI -->
  <div class="controls-container" id="filters">
    <h3>Filter providers</h3>
    <label>
      <input type="checkbox" id="filterVirtual" />
      Offers virtual services
    </label>
    <label>
      <input type="checkbox" id="filterMedicaid" />
      Accepts Medicaid
    </label>
    <label>
      <input type="checkbox" id="filterPMHC" />
      Has PMH-C specialist
    </label>
    <hr />
    <small>
      Data source: internal CSV. This is a proof‑of‑concept map of maternal mental health providers in Chicagoland.
    </small>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Leaflet MarkerCluster JS (no longer used, can remove later if desired) -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- PapaParse for CSV parsing -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // --- CONFIG ---
    const csvFilePath = 'https://rcshepard.github.io/MMH/MMHdata.csv';

    // Columns we will hide from popup:
    const hiddenFields = ['LATITUDE', 'LONGITUDE'];

    // --- Initialize map ---
    const map = L.map('map').setView([41.88, -87.63], 12); // Center on Chicago

    // Esri Light Gray Canvas basemap
    L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}',
      {
        attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
        maxZoom: 16
      }
    ).addTo(map);

    // We will manage our own "clusters" with proportional circle markers
    const markersLayerGroup = L.layerGroup().addTo(map);

    // Store original data for filtering
    let allProviderData = [];

    // --- Utility: build popup HTML for a row ---
    function buildPopupHtml(row) {
      const url = row.URL && row.URL.trim() ? row.URL.trim() : null;
      const name = row.NAME || 'Provider';

      let html = '<div class="provider-popup">';
      html += '<strong>' + name + '</strong>';

      if (url) {
        const safeUrl = url.startsWith('http') ? url : 'http://' + url;
        html += '<br/><a href="' + safeUrl + '" target="_blank" rel="noopener noreferrer">Website</a>';
      }

      html += '<br/><br/><table>';

      for (const key in row) {
        if (!row.hasOwnProperty(key)) continue;
        if (hiddenFields.includes(key)) continue;
        if (key.startsWith('Unnamed')) continue; // Skip empty extra columns

        let label = key.replace(/_/g, ' ');
        const value = row[key] == null ? '' : String(row[key]).trim();
        if (value === '') continue;

        html += '<tr><th>' + label + '</th><td>' + value + '</td></tr>';
      }

      html += '</table></div>';
      return html;
    }

    // --- Utility: create a marker with different icons for agency vs individual ---
    function createProviderMarker(row) {
      const lat = parseFloat(row.LATITUDE);
      const lng = parseFloat(row.LONGITUDE);
      if (isNaN(lat) || isNaN(lng)) return null;

      const numProviders = row.NUM_PROVIDERS ? parseInt(row.NUM_PROVIDERS, 10) : null;
      const type = (row.AGENCY_INDIVIDUAL || '').toString().trim().toUpperCase();

      // Choose an icon based on AGENCY_INDIVIDUAL
      const isAgency =
        type === 'AGENCY' ||
        type === 'A' ||
        type === 'AGENCIES';

      const iconClass = isAgency ? 'agency-icon' : 'individual-icon';

      const icon = L.divIcon({
        className: '',
        html: '<span class="' + iconClass + '"></span>',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });

      const marker = L.marker([lat, lng], { icon });

      // Add a small label with number of providers if present
      if (!isNaN(numProviders) && numProviders > 0) {
        const labelHtml = '<div class="provider-label">' + numProviders + '</div>';
        marker.bindTooltip(labelHtml, {
          permanent: true,
          direction: 'top',
          className: 'provider-count-label'
        });
      }

      // Bind popup
      marker.bindPopup(buildPopupHtml(row));

      return marker;
    }

    // --- Filtering logic ---
    function passesFilters(row, filters) {
      if (filters.virtual && String(row.VIRTUAL).toUpperCase() !== 'Y') return false;
      if (filters.medicaid && String(row.MEDICAID).toUpperCase() !== 'Y') return false;
      if (filters.pmhc && String(row.PMH_C).toUpperCase() !== 'Y') return false;
      return true;
    }

    // --- Simple clustering for proportional symbols ---
    // We treat markers within "clusterRadiusMeters" as a single cluster and show
    // one circle marker proportional to the number of points.
    const clusterRadiusMeters = 100; // you can tune this

    function clusterMarkers(markers) {
      const clusters = [];

      markers.forEach(marker => {
        const latLng = marker.getLatLng();
        let foundCluster = null;

        for (let i = 0; i < clusters.length; i++) {
          const clusterCenter = clusters[i].latLng;
          const distance = map.distance(latLng, clusterCenter);
          if (distance <= clusterRadiusMeters) {
            foundCluster = clusters[i];
            break;
          }
        }

        if (foundCluster) {
          foundCluster.markers.push(marker);
          // Recompute cluster center as average (simple approach)
          const len = foundCluster.markers.length;
          const avgLat =
            (foundCluster.latLng.lat * (len - 1) + latLng.lat) / len;
          const avgLng =
            (foundCluster.latLng.lng * (len - 1) + latLng.lng) / len;
          foundCluster.latLng = L.latLng(avgLat, avgLng);
        } else {
          clusters.push({
            latLng: latLng,
            markers: [marker]
          });
        }
      });

      return clusters;
    }

    function applyFiltersAndRender() {
      const filters = {
        virtual: document.getElementById('filterVirtual').checked,
        medicaid: document.getElementById('filterMedicaid').checked,
        pmhc: document.getElementById('filterPMHC').checked
      };

      markersLayerGroup.clearLayers();

      const markers = [];
      allProviderData.forEach(row => {
        if (passesFilters(row, filters)) {
          const marker = createProviderMarker(row);
          if (marker) {
            markers.push(marker);
          }
        }
      });

      if (markers.length === 0) {
        return;
      }

      // Cluster markers and draw proportional circles
      const clusters = clusterMarkers(markers);

      // For proportional circles, we can scale radius by sqrt of count
      // so area ~ count. Adjust scaleFactor to taste.
      const scaleFactor = 4;
      const allClusterMarkers = [];

      clusters.forEach(cluster => {
        const count = cluster.markers.length;
        const radius = Math.max(8, Math.sqrt(count) * scaleFactor);

        // Circle marker representing the cluster
        const circle = L.circleMarker(cluster.latLng, {
          radius: radius,
          color: '#0056b3',
          weight: 2,
          fillColor: '#4da3ff',
          fillOpacity: 0.6
        }).addTo(markersLayerGroup);

        // Label the circle with the count
        circle.bindTooltip(
          '<div class="provider-label">' + count + '</div>',
          {
            permanent: true,
            direction: 'center',
            className: 'provider-count-label'
          }
        );

        // When clicked, show a popup that concatenates the popups for the cluster
        circle.on('click', () => {
          let html = '';
          cluster.markers.forEach(m => {
            const content = m.getPopup() ? m.getPopup().getContent() : '';
            if (content) {
              if (html !== '') {
                html += '<hr/>';
              }
              html += content;
            }
          });
          circle.bindPopup(html).openPopup();
        });

        allClusterMarkers.push(circle);
      });

      // Fit map to all cluster circles
      const group = L.featureGroup(allClusterMarkers);
      map.fitBounds(group.getBounds().pad(0.2));
    }

    // --- Load and parse CSV ---
    Papa.parse(csvFilePath, {
      header: true,
      download: true,
      dynamicTyping: false,
      complete: function(results) {
        const rows = results.data.filter(row => {
          // Skip completely empty rows
          const hasId = row.ID && String(row.ID).trim() !== '';
          const hasName = row.NAME && String(row.NAME).trim() !== '';
          return hasId || hasName;
        });

        allProviderData = rows;

        // Initial render
        applyFiltersAndRender();
      },
      error: function(err) {
        console.error('Error loading CSV:', err);
        alert('Failed to load provider data CSV. Check console for details.');
      }
    });

    // --- Wire up filter UI events ---
    document.getElementById('filterVirtual').addEventListener('change', applyFiltersAndRender);
    document.getElementById('filterMedicaid').addEventListener('change', applyFiltersAndRender);
    document.getElementById('filterPMHC').addEventListener('change', applyFiltersAndRender);
  </script>
</body>
</html>
